<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin panel</title>
  <link rel="stylesheet" href="/webjars/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    :root {
      --edit-color: #4BA0B4;
    }

    .sidebar {
      min-height: calc(100vh - 56px);
      background-color: #f8f9fa;
      border-right: 1px solid #dee2e6;
    }

    .nav-link.active {
      background-color: #0d6efd;
      color: white !important;
    }

    .btn-edit {
      background-color: var(--edit-color);
      border-color: var(--edit-color);
      color: white;
    }

    .btn-edit:hover {
      background-color: #3a889a;
      border-color: #3a889a;
      color: white;
    }

    .table th {
      background-color: #f8f9fa;
    }

    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
    }

    .nav-tabs .nav-link {
      color: #495057;
      background-color: transparent;
      border: 1px solid transparent;
      border-top-left-radius: 0.25rem;
      border-top-right-radius: 0.25rem;
      padding: 0.5rem 1rem;
    }

    .nav-tabs .nav-link:hover {
      border-color: #e9ecef #e9ecef #dee2e6;
      isolation: isolate;
    }

    .nav-tabs .nav-link.active {
      color: #0d6efd;
      background-color: #fff;
      border-color: #dee2e6 #dee2e6 #fff;
      font-weight: 500;
    }

    .nav-tabs .nav-link,
    .nav-tabs .nav-link.active {
      color: inherit !important;
      opacity: 1 !important;
    }

    .tab-content {
      padding: 1rem;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 0.25rem 0.25rem;
    }

    .form-title-left {
      text-align: left;
      margin: 0 0 1.5rem 0;
      padding: 0 0 0.75rem 0;
      font-weight: 600;
      color: #212529;
      border-bottom: 2px solid #4BA0B4;
      width: 100%;
    }

    .modal-title.form-title-left {
      margin: 0;
      padding: 0.5rem 0;
      border-bottom: none;
      font-size: 1.25rem;
    }

    .form-label-centered {
      display: block;
      width: 100%;
      text-align: center;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #495057;
    }

    .form-control-centered,
    .form-select-centered {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      text-align: left;
      display: block;
      padding: 0.375rem 0.75rem;
    }

    input[readonly].form-control-centered,
    input[readonly].form-control-centered:focus {
      text-align: center;
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      border-color: #ced4da;
    }

    .form-select-centered[multiple] {
      text-align: left;
      height: 70px;
      min-height: 70px;
      max-height: 70px;
      overflow: hidden;
    }

    .form-select-centered[multiple] option {
      text-align: left;
      padding: 0.25rem 0.5rem;
    }

    .form-select-centered[multiple][readonly] option {
      background-color: #f8f9fa;
      color: #6c757d;
    }

    .form-centered-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .modal-body p.text-center {
      text-align: center !important;
      font-size: 1.1rem;
    }

    .form-buttons-centered {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid #e9ecef;
      width: 100%;
    }

    .form-buttons-centered .btn {
      min-width: 150px;
      padding: 0.5rem 2rem;
      font-weight: 500;
    }

    .modal-footer.justify-content-end {
      padding: 1rem;
      border-top: 1px solid #dee2e6;
      justify-content: flex-end !important;
    }

    .modal-footer.justify-content-end .btn {
      min-width: 80px;
      margin-left: 0.5rem;
    }

    @media (max-width: 576px) {
      .form-control-centered,
      .form-select-centered {
        max-width: 100%;
      }

      .form-title-left {
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .form-buttons-centered .btn {
        min-width: 120px;
        padding: 0.5rem 1rem;
      }

      .modal-footer.justify-content-end {
        justify-content: center !important;
      }

      .modal-footer.justify-content-end .btn {
        margin: 0.25rem;
      }
    }

    .modal-body .form-label-centered {
      font-size: 0.95rem;
    }

    .modal-body .form-control-centered {
      max-width: 250px;
    }

    .tab-pane .form-centered-container {
      padding: 1rem 0;
    }

    select.form-select-centered[multiple][disabled] {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    select.form-select-centered[multiple][disabled] option {
      color: #6c757d;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
            <span class="navbar-brand mb-0 h6">
                <span th:text="${currentUser.email}">email</span> with roles:
                <span th:each="role, stat : ${currentUser.roles}">
                    <span th:text="${role.name}">role</span>
                    <span th:unless="${stat.last}">, </span>
                </span>
            </span>
    <form th:action="@{/logout}" method="post">
      <button type="submit" class="btn btn-outline-light">Logout</button>
    </form>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-3 col-lg-2 sidebar">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-role="admin">
              Admin
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-role="user">
              User
            </a>
          </li>
        </ul>
      </div>
    </div>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div id="admin-content" class="content-section">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Admin panel</h1>
        </div>

        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab"
                    data-bs-target="#users" type="button" role="tab"
                    aria-controls="users" aria-selected="true">
              <span class="text-dark">Users table</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="new-user-tab" data-bs-toggle="tab"
                    data-bs-target="#new-user" type="button" role="tab"
                    aria-controls="new-user" aria-selected="false">
              <span class="text-dark">New User</span>
            </button>
          </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
          <div class="tab-pane fade show active" id="users" role="tabpanel">
            <h3 class="h4 mb-3">All users</h3>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Age</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Edit</th>
                  <th>Delete</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${allUsers}">
                  <td th:text="${user.id}">1</td>
                  <td th:text="${user.firstName}">John</td>
                  <td th:text="${user.lastName}">Doe</td>
                  <td th:text="${user.age}">30</td>
                  <td th:text="${user.email}">john@example.com</td>
                  <td>
                                                <span th:each="role, stat : ${user.roles}">
                                                    <span th:text="${role.name}">ROLE_USER</span>
                                                    <span th:unless="${stat.last}">, </span>
                                                </span>
                  </td>
                  <td>
                    <button class="btn btn-edit btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#editUserModal"
                            th:data-user-id="${user.id}"
                            onclick="loadUserForEdit(this)">
                      Edit
                    </button>
                  </td>
                  <td>
                    <button class="btn btn-danger btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteUserModal"
                            th:data-user-id="${user.id}"
                            onclick="loadUserForDelete(this)">
                      Delete
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane fade" id="new-user" role="tabpanel">
            <h3 class="h4 mb-4 form-title-left">Add new User</h3>
            <form th:action="@{/admin/users}" method="post" class="form-centered-container">
              <div class="mb-4">
                <label for="firstName" class="form-label-centered">First Name</label>
                <input type="text" class="form-control form-control-centered" id="firstName"
                       name="firstName" required>
              </div>

              <div class="mb-4">
                <label for="lastName" class="form-label-centered">Last Name</label>
                <input type="text" class="form-control form-control-centered" id="lastName"
                       name="lastName" required>
              </div>

              <div class="mb-4">
                <label for="age" class="form-label-centered">Age</label>
                <input type="number" class="form-control form-control-centered" id="age"
                       name="age" min="1" max="150" required>
              </div>

              <div class="mb-4">
                <label for="email" class="form-label-centered">Email</label>
                <input type="email" class="form-control form-control-centered" id="email"
                       name="email" required>
              </div>

              <div class="mb-4">
                <label for="password" class="form-label-centered">Password</label>
                <input type="password" class="form-control form-control-centered" id="password"
                       name="password" required>
              </div>

              <div class="mb-4">
                <label class="form-label-centered">Roles</label>
                <select class="form-select form-select-centered" name="selectedRoles" multiple>
                  <option th:each="role : ${allRoles}"
                          th:value="${role.name}"
                          th:text="${role.name}">
                    ROLE
                  </option>
                </select>
              </div>

              <div class="form-buttons-centered">
                <button type="submit" class="btn btn-success btn-lg">Add new User</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div id="user-content" class="content-section" style="display: none;">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">User information-page</h1>
        </div>

        <h3 class="h4 mb-3">About user</h3>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
            <tr>
              <th>ID</th>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Age</th>
              <th>Email</th>
              <th>Role</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td th:text="${currentUser.id}">1</td>
              <td th:text="${currentUser.firstName}">John</td>
              <td th:text="${currentUser.lastName}">Doe</td>
              <td th:text="${currentUser.age}">30</td>
              <td th:text="${currentUser.email}">john@example.com</td>
              <td>
                                        <span th:each="role, stat : ${currentUser.roles}">
                                            <span th:text="${role.name}">ROLE_USER</span>
                                            <span th:unless="${stat.last}">, </span>
                                        </span>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editUserForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title form-title-left w-100">Edit user</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label-centered">ID</label>
            <input type="text" class="form-control form-control-centered"
                   name="id" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label-centered">First Name</label>
            <input type="text" class="form-control form-control-centered"
                   name="firstName" required>
          </div>

          <div class="mb-3">
            <label class="form-label-centered">Last Name</label>
            <input type="text" class="form-control form-control-centered"
                   name="lastName" required>
          </div>

          <div class="mb-3">
            <label class="form-label-centered">Age</label>
            <input type="number" class="form-control form-control-centered"
                   name="age" min="1" max="150" required>
          </div>

          <div class="mb-3">
            <label class="form-label-centered">Email</label>
            <input type="email" class="form-control form-control-centered"
                   name="email" required>
          </div>

          <div class="mb-3">
            <label class="form-label-centered">Password</label>
            <input type="password" class="form-control form-control-centered" name="password">
          </div>

          <div class="mb-3">
            <label class="form-label-centered">Roles</label>
            <select class="form-select form-select-centered" name="selectedRoles" multiple>
              <option th:each="role : ${allRoles}"
                      th:value="${role.name}"
                      th:text="${role.name}">
                ROLE
              </option>
            </select>
          </div>
        </div>
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-edit">Edit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title form-title-left w-100">Delete user</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <div class="mb-3">
          <label class="form-label-centered">ID</label>
          <input type="text" class="form-control form-control-centered"
                 name="id" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label-centered">First Name</label>
          <input type="text" class="form-control form-control-centered"
                 name="firstName" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label-centered">Last Name</label>
          <input type="text" class="form-control form-control-centered"
                 name="lastName" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label-centered">Age</label>
          <input type="text" class="form-control form-control-centered"
                 name="age" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label-centered">Email</label>
          <input type="text" class="form-control form-control-centered"
                 name="email" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label-centered">Roles</label>
          <select class="form-select form-select-centered form-select-compact"
                  name="roles" multiple disabled>
            <option th:each="role : ${allRoles}"
                    th:value="${role.name}"
                    th:text="${role.name}">
              ROLE_USER
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer justify-content-end">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

<script src="/webjars/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>

  document.addEventListener('DOMContentLoaded', function() {
    const adminLink = document.querySelector('.nav-link[data-role="admin"]');
    const userLink = document.querySelector('.nav-link[data-role="user"]');

    if (adminLink && userLink) {
      adminLink.classList.add('active');
      document.getElementById('admin-content').style.display = 'block';
      document.getElementById('user-content').style.display = 'none';

      adminLink.addEventListener('click', function(e) {
        e.preventDefault();

        adminLink.classList.add('active');
        userLink.classList.remove('active');

        document.getElementById('admin-content').style.display = 'block';
        document.getElementById('user-content').style.display = 'none';

        const firstTab = document.querySelector('#adminTabs .nav-link');
        if (firstTab) {
          const tab = new bootstrap.Tab(firstTab);
          tab.show();
        }
      });

      userLink.addEventListener('click', function(e) {
        e.preventDefault();

        userLink.classList.add('active');
        adminLink.classList.remove('active');

        document.getElementById('user-content').style.display = 'block';
        document.getElementById('admin-content').style.display = 'none';
      });
    }

    const triggerTabList = document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]');
    triggerTabList.forEach(triggerEl => {
      triggerEl.addEventListener('click', event => {
        event.preventDefault();
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();
      });
    });

    document.querySelectorAll('#adminTabs .nav-link').forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (event) {
        document.querySelectorAll('#adminTabs .nav-link').forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });

        event.target.classList.add('active');
        event.target.setAttribute('aria-selected', 'true');

        document.querySelectorAll('#adminTabsContent .tab-pane').forEach(pane => {
          pane.classList.remove('show', 'active');
        });

        const target = event.target.getAttribute('data-bs-target');
        if (target) {
          const targetPane = document.querySelector(target);
          if (targetPane) {
            targetPane.classList.add('show', 'active');
          }
        }
      });
    });
  });

  let userToDeleteId = null;

  async function loadUserForEdit(button) {
    const userId = button.dataset.userId;

    try {
      const response = await fetch(`/admin/users/${userId}`);
      const user = await response.json();

      document.querySelector('#editUserForm input[name="id"]').value = user.id;
      document.querySelector('#editUserForm input[name="firstName"]').value = user.firstName;
      document.querySelector('#editUserForm input[name="lastName"]').value = user.lastName;
      document.querySelector('#editUserForm input[name="age"]').value = user.age;
      document.querySelector('#editUserForm input[name="email"]').value = user.email;

      document.querySelector('#editUserForm input[name="password"]').value = '';

      const roleSelect = document.querySelector('#editUserForm select[name="selectedRoles"]');
      Array.from(roleSelect.options).forEach(option => {
        option.selected = user.roles.some(role => role.name === option.value);
      });

      document.getElementById('editUserForm').action = `/admin/users/${userId}`;

    } catch (error) {
      console.error('Error loading user:', error);
      alert('Error loading user data');
    }
  }

  async function loadUserForDelete(button) {
    const userId = button.dataset.userId;
    userToDeleteId = userId;

    try {
      const response = await fetch(`/admin/users/${userId}`);
      const user = await response.json();

      const modal = document.querySelector('#deleteUserModal');
      modal.querySelector('input[name="id"]').value = user.id;
      modal.querySelector('input[name="firstName"]').value = user.firstName;
      modal.querySelector('input[name="lastName"]').value = user.lastName;
      modal.querySelector('input[name="age"]').value = user.age;
      modal.querySelector('input[name="email"]').value = user.email;

      const rolesSelect = modal.querySelector('select[name="roles"]');
      if (rolesSelect && user.roles) {
        Array.from(rolesSelect.options).forEach(option => {
          option.selected = false;
        });

        user.roles.forEach(userRole => {
          Array.from(rolesSelect.options).forEach(option => {
            if (option.value === userRole.name) {
              option.selected = true;
            }
          });
        });
      }

    } catch (error) {
      console.error('Error loading user for deletion:', error);
      alert('Error loading user data');
    }
  }

  async function confirmDelete() {
    if (!userToDeleteId) return;

    try {
      const response = await fetch(`/admin/users/${userToDeleteId}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      });

      if (response.ok) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
        modal.hide();
        location.reload();
      } else {
        alert('Error deleting user');
      }
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Error deleting user');
    }
  }

  document.getElementById('editUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const userId = formData.get('id');

    try {
      const response = await fetch(`/admin/users/${userId}`, {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
        modal.hide();
        location.reload();
      } else {
        alert('Error updating user');
      }
    } catch (error) {
      console.error('Error updating user:', error);
      alert('Error updating user');
    }
  });

  const triggerTabList = document.querySelectorAll('#adminTabs button');
  triggerTabList.forEach(triggerEl => {
    const tabTrigger = new bootstrap.Tab(triggerEl);
    triggerEl.addEventListener('click', event => {
      event.preventDefault();
      tabTrigger.show();
    });
  });
</script>
</body>
</html>